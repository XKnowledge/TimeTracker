<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时光刻录 - 每日时间记录</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #f8f7f4;
            --bg-subtle: #f0efe9;
            --fg: #1a1d23;
            --fg-muted: #6b7280;
            --accent: #d97706;
            --accent-light: #fef3c7;
            --card: #ffffff;
            --border: #e5e5e0;
            --success: #059669;
            --danger: #dc2626;
            --highlight: #3b82f6;
        }

        * {
            font-family: 'Noto Sans SC', sans-serif;
        }

        /* 隐藏滚动条 */
        ::-webkit-scrollbar {
            display: none;
        }

        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 窗口拖拽区域 */
        .title-bar {
            -webkit-app-region: drag;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            height: 32px;
            background: var(--bg-subtle);
            border-bottom: 1px solid var(--border);
            padding-right: 8px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .window-controls {
            -webkit-app-region: no-drag;
            display: flex;
            gap: 8px;
        }

        .window-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: transparent;
        }

        .window-btn:hover {
            background: var(--border);
        }

        .window-btn.close:hover {
            background: #e53935;
            color: white;
        }

        /* 内容区域顶部留出标题栏空间 */
        .content-wrapper {
            padding-top: 32px;
        }

        .font-display {
            font-family: 'Space Grotesk', sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--fg);
        }

        /* 网格背景 */
        .grid-bg {
            background-image:
                linear-gradient(var(--border) 1px, transparent 1px),
                linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: -1px -1px;
        }

        /* 渐变装饰 */
        .gradient-orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            pointer-events: none;
            z-index: 0;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            top: -100px;
            right: -100px;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            bottom: -50px;
            left: -50px;
        }

        /* 表格样式 */
        .time-table {
            border-collapse: separate;
            border-spacing: 0;
        }

        .time-table th {
            background: var(--bg-subtle);
            font-weight: 600;
            text-align: left;
            padding: 12px 16px;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .time-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .time-table tr:hover td {
            background: var(--bg-subtle);
        }

        .time-table tr.important-row td {
            background: var(--accent-light);
        }

        .time-table tr.important-row:hover td {
            background: #fde68a;
        }

        /* 输入框样式 */
        .input-clean {
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
            font-size: 14px;
            color: var(--fg);
        }

        .input-clean:focus {
            background: var(--card);
            box-shadow: 0 0 0 2px var(--highlight);
            border-radius: 4px;
            padding: 4px 8px;
            margin: -4px -8px;
            width: calc(100% + 16px);
        }

        .time-input {
            font-family: 'Space Grotesk', monospace;
            font-weight: 500;
        }

        /* 复选框样式 */
        .checkbox-custom {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .checkbox-custom:hover {
            border-color: var(--accent);
        }

        .checkbox-custom.checked {
            background: var(--accent);
            border-color: var(--accent);
        }

        .checkbox-custom svg {
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s;
        }

        .checkbox-custom.checked svg {
            opacity: 1;
            transform: scale(1);
        }

        /* 按钮样式 */
        .btn-primary {
            background: var(--fg);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: #2d3139;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--card);
            color: var(--fg);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: var(--bg-subtle);
            border-color: var(--fg-muted);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: transparent;
        }

        .btn-icon:hover {
            background: var(--bg-subtle);
        }

        .btn-icon.danger:hover {
            background: #fef2f2;
            color: var(--danger);
        }

        /* 统计卡片 */
        .stat-card {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .stat-card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        /* 进度条 */
        .progress-bar {
            height: 8px;
            background: var(--bg-subtle);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #fbbf24);
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }

        /* 日期选择器 */
        .date-picker {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-picker:hover {
            border-color: var(--fg-muted);
        }

        .date-picker:focus {
            outline: none;
            border-color: var(--highlight);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* 动画 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .animate-fade-in {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }

        /* 提示弹窗 */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
            color: white;
        }

        .toast.error {
            background: var(--danger);
            color: white;
        }

        /* 持续时间徽章 */
        .duration-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            background: var(--bg-subtle);
            color: var(--fg-muted);
        }

        .duration-badge.important {
            background: var(--accent-light);
            color: var(--accent);
        }

        /* 响应式 */
        @media (max-width: 768px) {

            .time-table th,
            .time-table td {
                padding: 10px 12px;
            }

            .stat-card {
                padding: 16px;
            }
        }

        /* 减少动画 */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--fg-muted);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.3;
        }

        /* 表格容器滚动 */
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--card);
        }
    </style>
</head>

<body class="min-h-screen grid-bg">
    <!-- 标题栏（用于拖拽窗口） -->
    <div class="title-bar">
        <div class="window-controls">
            <button class="window-btn" onclick="minimizeWindow()" title="最小化">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
            <button class="window-btn" onclick="maximizeWindow()" title="最大化">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="4" y="4" width="16" height="16" rx="2"></rect>
                </svg>
            </button>
            <button class="window-btn close" onclick="closeWindow()" title="关闭">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                    <line x1="6" y1="18" x2="18" y2="6"></line>
                </svg>
            </button>
        </div>
    </div>
    <!-- 内容区域 -->
    <div class="content-wrapper">
    <!-- 装饰球体 -->
    <div class="gradient-orb orb-1"></div>
    <div class="gradient-orb orb-2"></div>
    <div class="relative z-10 max-w-5xl mx-auto px-4 py-8 md:py-12">
        <!-- 头部 -->
        <header class="mb-8 animate-fade-in" style="animation-delay: 0.1s;">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="font-display text-3xl md:text-4xl font-bold tracking-tight mb-2">
                        时光刻录
                    </h1>
                    <p class="text-[var(--fg-muted)]">记录每一刻，洞察时间的流向</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="goToPrevDay()" class="btn-icon" aria-label="前一天">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M15 18l-6-6 6-6" />
                        </svg>
                    </button>
                    <input type="date" id="datePicker" class="date-picker font-display" onchange="changeDate()">
                    <button onclick="goToNextDay()" class="btn-icon" aria-label="后一天">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M9 18l6-6-6-6" />
                        </svg>
                    </button>
                    <button onclick="goToToday()" class="btn-secondary text-sm ml-2">今天</button>
                    <div class="h-6 w-px bg-[var(--border)] mx-1"></div>
                    <button onclick="exportData()" class="btn-secondary text-sm flex items-center gap-1" title="导出数据">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="17 8 12 3 7 8" />
                            <line x1="12" y1="3" x2="12" y2="15" />
                        </svg>
                        导出
                    </button>
                    <button onclick="importData()" class="btn-secondary text-sm flex items-center gap-1" title="导入数据">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" y1="15" x2="12" y2="3" />
                        </svg>
                        导入
                    </button>
                </div>
            </div>
        </header>
        <!-- 开始时间设置 -->
        <div class="stat-card mb-6 animate-fade-in" style="animation-delay: 0.2s;">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <label class="block text-sm font-medium text-[var(--fg-muted)] mb-1">每日开始时间</label>
                    <div class="flex items-center gap-2">
                        <input type="time" id="startTime" value="08:00" class="date-picker font-display text-lg"
                            onchange="saveStartTime()">
                        <span class="text-sm text-[var(--fg-muted)]">作为时间计算基准点</span>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-center">
                        <div class="text-2xl font-display font-bold" id="totalEvents">0</div>
                        <div class="text-xs text-[var(--fg-muted)]">事件总数</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-display font-bold" id="importantCount">0</div>
                        <div class="text-xs text-[var(--fg-muted)]">重要事件</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 统计面板 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="stat-card animate-fade-in" style="animation-delay: 0.3s;">
                <div class="text-sm text-[var(--fg-muted)] mb-2">总时间跨度</div>
                <div class="text-3xl font-display font-bold" id="totalSpan">0 分钟</div>
                <div class="text-sm text-[var(--fg-muted)] mt-1" id="totalSpanHours"></div>
            </div>
            <div class="stat-card animate-fade-in" style="animation-delay: 0.4s;">
                <div class="text-sm text-[var(--fg-muted)] mb-2">重要事件时长</div>
                <div class="text-3xl font-display font-bold text-[var(--accent)]" id="importantTime">0 分钟</div>
                <div class="text-sm text-[var(--fg-muted)] mt-1" id="importantTimeHours"></div>
            </div>
            <div class="stat-card animate-fade-in" style="animation-delay: 0.5s;">
                <div class="text-sm text-[var(--fg-muted)] mb-2">重要事件占比</div>
                <div class="text-3xl font-display font-bold" id="importantRatio">0%</div>
                <div class="progress-bar mt-3">
                    <div class="progress-fill" id="ratioProgress" style="width: 0%"></div>
                </div>
            </div>
        </div>
        <!-- 表格区域 -->
        <div class="animate-fade-in" style="animation-delay: 0.6s;">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display text-xl font-semibold">事件记录</h2>
                <button onclick="addEvent()" class="btn-primary flex items-center gap-2">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    添加事件
                </button>
            </div>
            <div class="table-container" id="tableContainer">
                <table class="time-table w-full" id="eventTable">
                    <thead>
                        <tr>
                            <th style="width: 100px;">重要</th>
                            <th>事件描述</th>
                            <th style="width: 120px;">完成时间</th>
                            <th style="width: 120px;">持续时间</th>
                            <th style="width: 60px;"></th>
                        </tr>
                    </thead>
                    <tbody id="eventBody">
                        <!-- 动态生成 -->
                    </tbody>
                </table>
                <div class="empty-state" id="emptyState">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <p class="font-medium mb-2">暂无事件记录</p>
                    <p class="text-sm">点击上方"添加事件"开始记录你的一天</p>
                </div>
            </div>
        </div>
        <!-- 底部说明 -->
        <div class="mt-8 text-center text-sm text-[var(--fg-muted)] animate-fade-in" style="animation-delay: 0.7s;">
            <p>提示：事件需按完成时间顺序录入，系统自动计算持续时间与重要事件占比</p>
        </div>
    </div>
    </div>
    <!-- 提示弹窗 -->
    <div class="toast error" id="toast"></div>
    <script>
        // 全局状态
        let currentDate = '';
        let allData = {};
        let isLoading = false;

        // 检查是否在 Electron 环境中
        function isElectron() {
            return typeof window.timeTrackerAPI !== 'undefined';
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 设置今天日期
            const today = new Date();
            currentDate = formatDate(today);
            document.getElementById('datePicker').value = currentDate;
            // 加载数据
            await loadData();
            renderTable();
            updateStats();
        });

        // 格式化日期
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 加载数据
        async function loadData() {
            isLoading = true;
            try {
                if (isElectron()) {
                    allData = await window.timeTrackerAPI.loadData();
                } else {
                    // 降级到 localStorage（用于浏览器预览）
                    const stored = localStorage.getItem('timeTrackerData');
                    if (stored) {
                        allData = JSON.parse(stored);
                    }
                }
            } catch (error) {
                console.error('加载数据失败:', error);
                showError('加载数据失败');
            }
            // 确保当前日期有数据结构
            if (!allData) {
                allData = {};
            }
            if (!allData[currentDate]) {
                allData[currentDate] = {
                    startTime: '08:00',
                    events: []
                };
            }
            document.getElementById('startTime').value = allData[currentDate].startTime;
            isLoading = false;
        }

        // 保存数据
        async function saveData() {
            if (isLoading) return; // 加载过程中不保存
            try {
                if (isElectron()) {
                    await window.timeTrackerAPI.saveData(allData);
                } else {
                    // 降级到 localStorage
                    localStorage.setItem('timeTrackerData', JSON.stringify(allData));
                }
            } catch (error) {
                console.error('保存数据失败:', error);
                showError('保存数据失败');
            }
        }
        // 保存开始时间
        async function saveStartTime() {
            const startTime = document.getElementById('startTime').value;
            allData[currentDate].startTime = startTime;
            await saveData();
            updateStats();
        }
        // 切换日期
        async function changeDate() {
            currentDate = document.getElementById('datePicker').value;
            await loadData();
            renderTable();
            updateStats();
        }
        // 前一天
        async function goToPrevDay() {
            const date = new Date(currentDate);
            date.setDate(date.getDate() - 1);
            currentDate = formatDate(date);
            document.getElementById('datePicker').value = currentDate;
            await loadData();
            renderTable();
            updateStats();
        }
        // 后一天
        async function goToNextDay() {
            const date = new Date(currentDate);
            date.setDate(date.getDate() + 1);
            currentDate = formatDate(date);
            document.getElementById('datePicker').value = currentDate;
            await loadData();
            renderTable();
            updateStats();
        }
        // 回到今天
        async function goToToday() {
            const today = new Date();
            currentDate = formatDate(today);
            document.getElementById('datePicker').value = currentDate;
            await loadData();
            renderTable();
            updateStats();
        }
        // 添加事件
        async function addEvent() {
            const events = allData[currentDate].events;
            const newEvent = {
                id: Date.now(),
                important: false,
                description: '',
                time: ''
            };
            events.push(newEvent);
            await saveData();
            renderTable();
            // 聚焦到新行的描述输入���
            setTimeout(() => {
                const lastRow = document.querySelector('#eventBody tr:last-child');
                if (lastRow) {
                    const descInput = lastRow.querySelector('input[data-field="description"]');
                    if (descInput) descInput.focus();
                }
            }, 50);
        }
        // 删除事件
        async function deleteEvent(id) {
            const events = allData[currentDate].events;
            const index = events.findIndex(e => e.id === id);
            if (index > -1) {
                events.splice(index, 1);
                await saveData();
                renderTable();
                updateStats();
            }
        }
        // 切换重要标记
        async function toggleImportant(id) {
            const events = allData[currentDate].events;
            const event = events.find(e => e.id === id);
            if (event) {
                event.important = !event.important;
                await saveData();
                renderTable();
                updateStats();
            }
        }
        // 更新事件字段
        async function updateEvent(id, field, value) {
            const events = allData[currentDate].events;
            const event = events.find(e => e.id === id);
            if (event) {
                event[field] = value;
                await saveData();
                // 如果更新的是时间，需要验证并重新计算
                if (field === 'time') {
                    if (!validateTimeOrder()) {
                        showError('时间顺序错误，请按完成时间顺序输入');
                        return;
                    }
                }
                renderTable();
                updateStats();
            }
        }
        // 验证时间顺序
        function validateTimeOrder() {
            const events = allData[currentDate].events;
            const startTime = document.getElementById('startTime').value;
            for (let i = 0; i < events.length; i++) {
                const event = events[i];
                if (!event.time) continue;
                // 第一个事件不能早于开始时间
                if (i === 0) {
                    if (event.time < startTime) {
                        return false;
                    }
                } else {
                    // 后续事件不能早于前一个事件
                    const prevEvent = events[i - 1];
                    if (prevEvent.time && event.time < prevEvent.time) {
                        return false;
                    }
                }
            }
            return true;
        }
        // 计算时间差（分钟）
        function getTimeDiff(time1, time2) {
            const [h1, m1] = time1.split(':').map(Number);
            const [h2, m2] = time2.split(':').map(Number);
            return (h2 * 60 + m2) - (h1 * 60 + m1);
        }
        // 渲染表格
        function renderTable() {
            const events = allData[currentDate].events;
            const tbody = document.getElementById('eventBody');
            const emptyState = document.getElementById('emptyState');
            if (events.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            emptyState.style.display = 'none';
            const startTime = document.getElementById('startTime').value;
            let prevTime = startTime;
            tbody.innerHTML = events.map((event, index) => {
                const duration = event.time ? getTimeDiff(prevTime, event.time) : 0;
                const isValidDuration = duration > 0;
                // 更新 prevTime 用于下一个事件
                if (event.time) {
                    prevTime = event.time;
                }
                return `
	                    <tr class="${event.important ? 'important-row' : ''} animate-slide-in" style="animation-delay: ${index * 0.05}s">
	                        <td>
	                            <div class="checkbox-custom ${event.important ? 'checked' : ''}" 
	                                 onclick="toggleImportant(${event.id})"
	                                 role="checkbox"
	                                 aria-checked="${event.important}"
	                                 tabindex="0"
	                                 onkeydown="if(event.key==='Enter'||event.key===' ')toggleImportant(${event.id})">
	                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
	                                    <polyline points="20 6 9 17 4 12"></polyline>
	                                </svg>
	                            </div>
	                        </td>
	                        <td>
	                            <input type="text" 
	                                   class="input-clean" 
	                                   placeholder="输入事件描述..."
	                                   value="${escapeHtml(event.description)}"
	                                   data-field="description"
	                                   onchange="updateEvent(${event.id}, 'description', this.value)"
	                                   aria-label="事件描述">
	                        </td>
	                        <td>
	                            <input type="time" 
	                                   class="input-clean time-input" 
	                                   value="${event.time}"
	                                   data-field="time"
	                                   onchange="updateEvent(${event.id}, 'time', this.value)"
	                                   aria-label="完成时间">
	                        </td>
	                        <td>
	                            ${event.time && isValidDuration ?
                        `<span class="duration-badge ${event.important ? 'important' : ''}">
	                                    ${duration} 分钟
	                                </span>` :
                        event.time ?
                            '<span class="text-xs text-[var(--danger)]">时间错误</span>' :
                            '<span class="text-xs text-[var(--fg-muted)]">-</span>'
                    }
	                        </td>
	                        <td>
	                            <button class="btn-icon danger" onclick="deleteEvent(${event.id})" aria-label="删除事件">
	                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                                    <polyline points="3 6 5 6 21 6"></polyline>
	                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
	                                </svg>
	                            </button>
	                        </td>
	                    </tr>
	                `;
            }).join('');
        }
        // 更新统计
        function updateStats() {
            const events = allData[currentDate].events;
            const startTime = document.getElementById('startTime').value;
            // 事件统计
            const totalEvents = events.length;
            const importantCount = events.filter(e => e.important).length;
            document.getElementById('totalEvents').textContent = totalEvents;
            document.getElementById('importantCount').textContent = importantCount;
            // 时间计算
            let totalSpan = 0;
            let importantTime = 0;
            if (events.length > 0 && events[events.length - 1].time) {
                const lastTime = events[events.length - 1].time;
                totalSpan = getTimeDiff(startTime, lastTime);
                // 计算重要事件时间
                let prevTime = startTime;
                for (const event of events) {
                    if (event.time) {
                        const duration = getTimeDiff(prevTime, event.time);
                        if (duration > 0 && event.important) {
                            importantTime += duration;
                        }
                        prevTime = event.time;
                    }
                }
            }
            // 更新显示
            document.getElementById('totalSpan').textContent = `${totalSpan} 分钟`;
            document.getElementById('totalSpanHours').textContent = totalSpan > 0 ?
                `约 ${(totalSpan / 60).toFixed(1)} 小时` : '';
            document.getElementById('importantTime').textContent = `${importantTime} 分钟`;
            document.getElementById('importantTimeHours').textContent = importantTime > 0 ?
                `约 ${(importantTime / 60).toFixed(1)} 小时` : '';
            // 计算占比
            let ratio = 0;
            if (totalSpan > 0) {
                ratio = (importantTime / totalSpan * 100).toFixed(1);
            }
            document.getElementById('importantRatio').textContent = `${ratio}%`;
            document.getElementById('ratioProgress').style.width = `${Math.min(ratio, 100)}%`;
        }
        // 显示提���
        function showToast(message, type = 'error') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // 显示错误
        function showError(message) {
            showToast(message, 'error');
        }

        // 显示成功
        function showSuccess(message) {
            showToast(message, 'success');
        }
        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 导出数据
        async function exportData() {
            if (!isElectron()) {
                // 浏览器环境：下载 JSON 文件
                const dataStr = JSON.stringify(allData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `timetracker-backup-${formatDate(new Date())}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                return;
            }
            try {
                const result = await window.timeTrackerAPI.exportData(`timetracker-backup-${formatDate(new Date())}.json`);
                if (result.success) {
                    showSuccess('导出成功: ' + result.path);
                } else if (!result.canceled) {
                    showError('导出失败: ' + result.error);
                }
            } catch (error) {
                console.error('导出失败:', error);
                showError('导出失败');
            }
        }

        // 导入数据
        async function importData() {
            if (!isElectron()) {
                // 浏览器环境：使用文件选择器
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            try {
                                allData = JSON.parse(event.target.result);
                                await saveData();
                                renderTable();
                                updateStats();
                                showSuccess('导入成功');
                            } catch (error) {
                                showError('导入失败: 文件格式错误');
                            }
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
                return;
            }
            try {
                const result = await window.timeTrackerAPI.importData();
                if (result.success) {
                    allData = result.data;
                    // 确保当前日期有数据结构
                    if (!allData[currentDate]) {
                        allData[currentDate] = {
                            startTime: '08:00',
                            events: []
                        };
                    }
                    document.getElementById('startTime').value = allData[currentDate].startTime;
                    renderTable();
                    updateStats();
                    showSuccess('导入成功');
                } else if (!result.canceled) {
                    showError('导入失败: ' + result.error);
                }
            } catch (error) {
                console.error('导入失败:', error);
                showError('导入失败');
            }
        }

        // 窗口控制
        function minimizeWindow() {
            if (isElectron()) {
                window.timeTrackerAPI.minimizeWindow();
            }
        }

        function maximizeWindow() {
            if (isElectron()) {
                window.timeTrackerAPI.maximizeWindow();
            }
        }

        function closeWindow() {
            if (isElectron()) {
                window.timeTrackerAPI.closeWindow();
            }
        }
    </script>
</body>

</html>